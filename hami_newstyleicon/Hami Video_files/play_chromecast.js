function sessionListener(e){myPlayer.cast.session=e,myPlayer.cast.session.addUpdateListener(sessionUpdateListener.bind(this)),console.log("sessionListener New session ID: "+e.sessionId),myPlayer.cast.session.media[0]?myPlayer.cast.session.media[0].media.metadata.title===myPlayer.cast.currentMediaTitle&&myPlayer.cast.session.media[0].media.metadata.images[0].url===myPlayer.cast.currentMediaThumb&&(null==myPlayer.h5Player||myPlayer.h5Player.paused()||myPlayer.h5Player.pause(),onMediaDiscovered("activeSession",myPlayer.cast.session.media[0]),showCastPlayer()):myPlayer.cast.hasRight&&(myPlayer.cast.loadStream(),myPlayer.cast.currentMediaUrl&&(syncLocalPlayer(),loadMedia(myPlayer.cast.currentMediaUrl)))}function receiverListener(e){e===chrome.cast.ReceiverAvailability.AVAILABLE?(myPlayer.cast.castAble=!0,showCastable()):console.log("receiver list empty")}function onInitSuccess(){console.log("init success")}function onInitError(e){console.log("Error"+e.code)}function showCastable(){document.getElementById("divCast").style.display="",$.cookie("cast_intro")||($.cookie("cast_intro","1",{expires:365,path:"/"}),$(".overlay").css("display","block"),$(".cast_intro").css("display","block"))}function hideCastIntro(){$(".overlay").css("display","none"),$(".cast_intro").css("display","none")}function updateSoundBtn(){console.log("muted:"+myPlayer.cast.currentMedia.volume.muted);var e=$(".player_bar .sound a");myPlayer.cast.muted?e.css("background-image","url("+myPlayer.contextPath+"resources/player/chromecast/sound-02.png)"):e.css("background-image","url("+myPlayer.contextPath+"resources/player/chromecast/sound.png)")}function updatePlayBtn(){var e=$(".player_bar .play a");switch(myPlayer.cast.castPlayerState){case"PLAYING":e.css("background-image","url("+myPlayer.contextPath+"resources/player/chromecast/play-03.png)");break;case"PAUSED":e.css("background-image","url("+myPlayer.contextPath+"resources/player/chromecast/play-02.png)")}}function playMedia(){if(myPlayer.cast.currentMedia){switch(myPlayer.cast.castPlayerState){case"PLAYING":myPlayer.cast.currentMedia.pause(null,mediaCommandSuccessCallback.bind(this,"paused "+myPlayer.cast.currentMedia.sessionId),onError),myPlayer.cast.castPlayerState="PAUSED",myPlayer.cast.timer&&(clearInterval(myPlayer.cast.timer),myPlayer.cast.timer=null);break;case"PAUSED":myPlayer.cast.currentMedia.play(null,mediaCommandSuccessCallback.bind(this,"resumed "+myPlayer.cast.currentMedia.sessionId),onError),myPlayer.cast.castPlayerState="PLAYING",myPlayer.cast.timer=setInterval(updateCurrentTime.bind(this),myPlayer.cast.PROGRESS_BAR_UPDATE_DELAY)}updatePlayBtn()}}function syncLocalPlayer(){try{null!=myPlayer.h5Player&&(myPlayer.h5Player.paused()||myPlayer.h5Player.pause(),myPlayer.isLive||(myPlayer.cast.currentMediaTime=myPlayer.h5Player.currentTime()),myPlayer.cast.currentVolume=myPlayer.h5Player.volume(),slider&&$("#slider2").slider("option","value",100*myPlayer.cast.currentVolume),myPlayer.cast.muted=myPlayer.h5Player.muted())}catch(e){console.log("syncLocalPlayer error:"+e.message)}}function cast(){if(myPlayer.cast.hasRight){if(null==previewUrl){if(myPlayer.cast.loadStream(),null!=myPlayer.cast.errorMessage)return void alert(myPlayer.cast.errorMessage)}else myPlayer.cast.currentMediaUrl=previewUrl;if(null===myPlayer.cast.session){syncLocalPlayer(),showCasting("啟動中"),$("#imgCast").attr("src",myPlayer.contextPath+"resources/player/chromecast/cast_loading.png"),console.log("launching app...");try{chrome.cast.requestSession(onRequestSessionSuccess,onLaunchError)}catch(e){stopCasting(),null!=myPlayer.h5Player&&myPlayer.h5Player.paused()&&myPlayer.h5Player.play()}}else console.log("session exists..."),chrome.cast.requestSession(onRequestSessionSuccess,showGoogleCastDialogOnly),myPlayer.cast.session.media[0]&&myPlayer.cast.session.media[0].media.metadata.title===myPlayer.cast.currentMediaTitle&&myPlayer.cast.session.media[0].media.metadata.images[0].url===myPlayer.cast.currentMediaThumb||(syncLocalPlayer(),loadMedia(myPlayer.cast.currentMediaUrl))}else alert("本影片未提供電視版權，無法投放")}function sessionUpdateListener(e){e||(stopCasting(),myPlayer.isLive||myPlayer.h5Player.currentTime(myPlayer.cast.currentMediaTime),myPlayer.h5Player.volume(myPlayer.cast.currentVolume),myPlayer.h5Player.muted(myPlayer.cast.muted),null!=myPlayer.h5Player&&myPlayer.h5Player.paused()&&myPlayer.h5Player.play(),myPlayer.cast.session=null,myPlayer.cast.timer&&(clearInterval(myPlayer.cast.timer),myPlayer.cast.timer=null))}function onError(e){console.log("Error"+e.code)}function onRequestSessionSuccess(e){console.log("onRequestSessionSuccess session success: "+e.sessionId),myPlayer.cast.session=e,myPlayer.cast.session.addUpdateListener(sessionUpdateListener.bind(this)),loadMedia(myPlayer.cast.currentMediaUrl)}function onLaunchError(e){console.log("launch error code:"+e.code),"cancel"!=e.code&&"session_error"!=e.code||(stopCasting(),null!=myPlayer.h5Player&&myPlayer.h5Player.paused()&&myPlayer.h5Player.play())}function showGoogleCastDialogOnly(){console.log("showGoogleCastDialogOnly")}function onMediaDiscovered(e,a){console.log("new media session ID:"+a.mediaSessionId+" ("+e+")"),myPlayer.cast.currentMedia=a,showCasting("播放裝置<br/>"+myPlayer.cast.session.receiver.friendlyName),myPlayer.cast.currentMedia.addUpdateListener(onMediaStatusUpdate),startProgressTimer(),myPlayer.cast.castPlayerState="PLAYING"}function startProgressTimer(){myPlayer.cast.timer&&(clearInterval(myPlayer.cast.timer),myPlayer.cast.timer=null),myPlayer.cast.timer=setInterval(updateCurrentTime.bind(this),myPlayer.cast.PROGRESS_BAR_UPDATE_DELAY)}function updateCurrentTime(){myPlayer.cast.session&&myPlayer.cast.currentMedia&&(myPlayer.cast.currentMedia.media&&null!==myPlayer.cast.currentMedia.media.duration?myPlayer.cast.progressFlag&&(myPlayer.cast.currentMediaTime=myPlayer.cast.currentMedia.getEstimatedTime(),updateProgressBar(myPlayer.cast.currentMediaTime)):(slider&&($("#slider1").slider("option","value",100),$("#slider1").slider("disable")),myPlayer.cast.timer&&(clearInterval(myPlayer.cast.timer),myPlayer.cast.timer=null)))}function updateProgressBar(e){if(null!==myPlayer.cast.currentMedia.media.duration){var a=parseInt(100*e/myPlayer.cast.currentMedia.media.duration);slider&&$("#slider1").slider("option","value",a),$("#progress_tick").html(toHHMMSS(parseInt(e)))}}function seeking(){myPlayer.cast.progressFlag=0}function seekMedia(e){var a=new chrome.cast.media.SeekRequest;a.currentTime=e*myPlayer.cast.currentMedia.media.duration/100,myPlayer.cast.currentMedia.seek(a,onSeekSuccess.bind(this,"media seek done"),onError)}function onSeekSuccess(e){setTimeout(function(){myPlayer.cast.progressFlag=1},myPlayer.cast.PROGRESS_BAR_UPDATE_DELAY)}function showCastPlayer(){$(".player_bar .play a").css("background-image","url("+myPlayer.contextPath+"resources/player/chromecast/play-03.png)"),$("#castPlayer").show(),$("#imgCast").attr("src",myPlayer.contextPath+"resources/player/chromecast/cast_on.png")}function onMediaStatusUpdate(e){myPlayer.cast.castPlayerState=myPlayer.cast.currentMedia.playerState,e||(myPlayer.cast.castPlayerState="STOPPED"),e&&"PLAYING"===myPlayer.cast.currentMedia.playerState&&(myPlayer.cast.progressFlag&&(myPlayer.cast.currentMediaTime=myPlayer.cast.currentMedia.currentTime,updateProgressBar(myPlayer.cast.currentMediaTime),null!==myPlayer.cast.currentMedia.media.duration&&$("#duration").html(toHHMMSS(myPlayer.cast.currentMedia.media.duration)),myPlayer.cast.progressFlag=0,setTimeout(function(){myPlayer.cast.progressFlag=1},myPlayer.cast.PROGRESS_BAR_UPDATE_DELAY)),showCastPlayer()),updatePlayBtn()}function switchMute(){myPlayer.cast.muted?(myPlayer.cast.session.setReceiverMuted(!1,mediaCommandSuccessCallback.bind(this,"media set-volume done"),onError),myPlayer.cast.muted=!1):(myPlayer.cast.session.setReceiverMuted(!0,mediaCommandSuccessCallback.bind(this,"media set-muted done"),onError),myPlayer.cast.muted=!0),updateSoundBtn()}function setReceiverVolume(e,a){myPlayer.cast.session&&(a?myPlayer.cast.session.setReceiverMuted(!0,mediaCommandSuccessCallback.bind(this,"media set-muted done"),onError):(myPlayer.cast.session.setReceiverVolumeLevel(e,mediaCommandSuccessCallback.bind(this,"media set-volume done"),onError),myPlayer.cast.currentVolume=e))}function loadMedia(e){if(myPlayer.cast.session){showCasting("正在連線至<br/>"+myPlayer.cast.session.receiver.friendlyName);var a=new chrome.cast.media.MediaInfo(e);a.metadata=new chrome.cast.media.GenericMediaMetadata,a.metadata.metadataType=chrome.cast.media.MetadataType.GENERIC,a.contentType="application/x-mpegURL",a.metadata.title=myPlayer.cast.currentMediaTitle,a.metadata.images=[{url:myPlayer.cast.currentMediaThumb}];var r=new chrome.cast.media.LoadRequest(a);r.autoplay=!0,r.currentTime=myPlayer.cast.currentMediaTime,myPlayer.cast.castPlayerState="LOADING",myPlayer.cast.session.loadMedia(r,onMediaDiscovered.bind(this,"loadMedia"),onCastMediaError)}}function onCastMediaError(e){stopCasting(),null!=myPlayer.h5Player&&myPlayer.h5Player.paused()&&myPlayer.h5Player.play()}function stopMedia(){myPlayer.cast.currentMedia&&(myPlayer.cast.currentMedia.stop(null,mediaCommandSuccessCallback.bind(this,"stopped "+myPlayer.cast.currentMedia.sessionId),onError),myPlayer.cast.timer&&(clearInterval(myPlayer.cast.timer),myPlayer.cast.timer=null))}function mediaCommandSuccessCallback(e){}function stopApp(){null!==myPlayer.cast.session&&myPlayer.cast.session.stop(onStopAppSuccess,onError)}function onStopAppSuccess(){stopCasting(),myPlayer.cast.timer&&(clearInterval(myPlayer.cast.timer),myPlayer.cast.timer=null)}function showCasting(e){myPlayer.cast.casting=!0,$("#castingMsg").html(e),$("#casting").show(),null==myPlayer.h5Player||myPlayer.h5Player.paused()||syncLocalPlayer()}function stopCasting(){myPlayer.cast.casting=!1,myPlayer.cast.castPlayerState="IDLE",$("#casting").hide(),$("#castPlayer").hide(),$("#imgCast").attr("src",myPlayer.contextPath+"resources/player/chromecast/cast.png")}function toHHMMSS(e){var a=parseInt(e,10),r=Math.floor(a/3600),s=Math.floor((a-3600*r)/60),t=a-3600*r-60*s;return r<10&&(r="0"+r),s<10&&(s="0"+s),t<10&&(t="0"+t),r+":"+s+":"+t}var myPlayer=myPlayer||{};myPlayer.cast={hasRight:!1,castAble:!1,muted:!1,session:null,errorMessage:null,currentMedia:null,currentMediaUrl:null,currentMediaTime:0,progressFlag:1,timer:null,PROGRESS_BAR_UPDATE_DELAY:1e3,casting:!1,currentVolume:.5,castPlayerState:"IDLE",currentMediaTitle:"",currentMediaThumb:"",loadStream:function(){var e=null,a=null;try{var r=callSync(myPlayer.contextPath+"api/play.do",{id:myPlayer.contentID,type:"chromecast"},"json");"play"==r.msg?e=r.url:a=r.msg}catch(e){alert(e)}myPlayer.cast.currentMediaUrl=e,myPlayer.cast.errorMessage=a}};var slider=!0;window.__onGCastApiAvailable=function(e,a){e?initializeCastApi():console.log(a)},initializeCastApi=function(){var e=new chrome.cast.SessionRequest("B0E268AE"),a=chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED,r=new chrome.cast.ApiConfig(e,sessionListener,receiverListener,a);chrome.cast.initialize(r,onInitSuccess,onInitError)},$(function(){var e=$("#slider1"),a=$("#slider2"),r=$(".tooltip1"),s=$(".tooltip2");r.hide(),s.hide(),e.slider({range:"min",min:1,max:100,value:50,start:function(e,a){seeking();var s=parseInt(a.value*myPlayer.cast.currentMedia.media.duration/100);r.html(toHHMMSS(s)),r.fadeIn("fast")},stop:function(e,a){seekMedia(a.value),r.fadeOut("fast")},slide:function(e,a){var s=parseInt(a.value*myPlayer.cast.currentMedia.media.duration/100);r.html(toHHMMSS(s))}}),a.slider({range:"min",min:0,max:100,value:50,start:function(e,a){s.html(a.value),s.fadeIn("fast")},stop:function(e,a){setReceiverVolume(a.value/100,!1),s.fadeOut("fast")},slide:function(e,a){s.html(a.value)}})});